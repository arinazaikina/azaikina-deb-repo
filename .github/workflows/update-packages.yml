name: Обновление APT репозитория

on:
  push:
    branches:
      - main
    paths:
      - '**/*.deb'

jobs:
  update-packages:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Настройка Git конфигурации
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

    - name: Установка необходимых пакетов
      run: sudo apt-get update && sudo apt-get install -y dpkg-dev apt-utils gnupg

    - name: Импорт GPG ключа
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --import

    - name: Генерация и подписание файла Packages
      run: |
        dpkg-scanpackages --multiversion . > Packages
        gpg --batch --pinentry-mode loopback --default-key ${{ secrets.GPG_KEY_ID }} --output Packages.gpg --detach-sign Packages
        git add Packages Packages.gpg

    - name: Генерация и подписание файла Release
      run: |
        apt-ftparchive release . > Release
        gpg --batch --pinentry-mode loopback --default-key ${{ secrets.GPG_KEY_ID }} --output Release.gpg --detach-sign Release
        git add Release Release.gpg

    - name: Проверка наличия изменений
      id: git-check
      run: |
        git diff --exit-code || echo "changes=yes" >> $GITHUB_ENV

    - name: Коммит и пуш изменений, если они есть
      if: env.changes == 'yes'
      run: |
        git commit -m "Обновление файлов Packages и Release"
        git push
